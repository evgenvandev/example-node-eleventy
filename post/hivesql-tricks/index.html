<!DOCTYPE html><html lang="en" class="has-spaced-navbar-fixed-top"><head><meta charset="UTF-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><title>HiveSQL Tricks for A Better Life - Fizzy Blog</title><meta name="description" content="This post is mainly a notebook I use to record some practical HiveSQL tricks during daily work. Hopefully it will also make your life easier."><meta name="keywords" content="JAMStack, Hobby, Life"><link rel="icon" href="/example-node-eleventy/favicon.ico"><link rel="stylesheet" type="text/css" href="/example-node-eleventy/static/css/styles.css"><link rel="stylesheet" type="text/css" href="/example-node-eleventy/static/css/prism-line-numbers.css"><link rel="stylesheet" type="text/css" href="/example-node-eleventy/static/css/prism.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css"><script defer="defer" src="/example-node-eleventy/static/js/katex.min.js"></script><script defer="defer" src="/example-node-eleventy/static/js/auto-render.min.js" crossorigin="anonymous"></script></head><body class="has-background-light"><header><nav id="navbar" class="navbar is-white is-spaced has-shadow-thin is-fixed-top" style="z-index:999;" role="navigation" aria-label="main navigation"><div class="nav-container column is-paddingless is-12-tablet is-10-desktop is-10-widescreen is-8-fullhd"><div class="navbar-brand"><div class="navbar-item text-logo" alt="Fizzy" title="Fizzy - Exploring exciting things."><a class="align-vcentered" href="/example-node-eleventy/"><img src="/example-node-eleventy/favicon.ico" class="icon"> Fizzy<span class="main-color">.</span></a></div><a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarPrimary"><span aria-hidden="true"></span> <span aria-hidden="true"></span> <span aria-hidden="true"></span></a></div><div id="navbarPrimary" class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/example-node-eleventy/">Home </a><a class="navbar-item nav-current" href="/example-node-eleventy/post/">Posts </a><a class="navbar-item" href="/example-node-eleventy/tag/">Topics </a><a class="navbar-item" href="/example-node-eleventy/author/">Authors </a><a class="navbar-item" href="/example-node-eleventy/archives/">Archives </a><a class="navbar-item" href="/example-node-eleventy/about/">About</a><div class="fizzy-search"><div class="navbar-item" id="search-btn"><i class="iconfont icon-search"></i></div><div class="field has-addons" style="display:none" id="search-container"><form id="search-form" class="control has-icons-left" action="/example-node-eleventy/search/" method="get"><input id="search-input" type="text" class="input" placeholder="Search" name="q"> <span class="icon is-left"><i class="iconfont icon-search"></i></span></form><div class="control" id="close-btn"><button type="submit" class="button" style="padding-left:calc(0.75em - 1px);padding-right:calc(0.75em - 1px);"><i class="iconfont icon-cross"></i></button></div></div></div></div></div></div></nav></header><section class="section is-mobile-paddingless"><div class="columns"><div class="column is-hidden-touch is-1-desktop is-1-widescreen is-2-fullhd"></div><div class="column is-12-tablet is-10-desktop is-10-widescreen is-8-fullhd"><article class="single-article"><div class="box is-paddingless is-shadowless is-full-mobile is-centered"><div class="spacing-25 is-hidden-mobile"></div><section class="post-wrap"><div class="has-2-ends is-montserrat is-uppercase is-size-6"><div class="end meta-text date">Apr 2, 2020</div><div class="end meta-text reading_time">2 minutes</div></div><h1 class="title post-title">Hivesql Tricks For A Better Life</h1><div class="buttons tags has-text-weight-semibold"><button class="button is-static is-size-7-mobile" style="padding:0 0.5em;min-width:2.5em" title="View all tags" alt="View all tags"><i class="iconfont icon-tag"></i></button> <a href="/example-node-eleventy/tag/data/" class="button is-size-7-mobile has-text-weight-semibold">Data</a></div><div id="content" class="content post-content is-size-6-mobile line-numbers"><p>This post is mainly a notebook I use to record some practical HiveSQL tricks during daily work. Hopefully it will also make your life easier.</p><h2>Concatenate strings from several rows by SQL</h2><p>We use the same logic as we did in Pandas to perform the task.</p><pre><code class="language-SQL">SELECT  t.user_id
        ,concat_ws(',',collect_set(tag)) AS tags
        ,concat_ws(',',collect_set(product)) AS products
FROM    table_name
GROUP BY user_id
</code></pre><center>all tags and products will grouped by each user name, seperated by comma</center><h2>Remove duplicates in a more efficient way</h2><p>We use <code>ROW_NUMBER()</code> function to identify the replicated rows and then simply select the rows we need.</p><pre><code class="language-SQL">SELECT	user_id
        ,product_id
        ,order_time
FROM (
        SELECT	user_id
                ,product_id
                ,order_time
                ,ROW_NUMBER() OVER (PARTITION BY user_id, product_id ORDER BY order_time ASC) AS rn
        FROM    orders
) t
WHERE t.rn = 1
</code></pre><center>We select the first record for any products purchased by all users</center><p>First we select all rows like we'd normally do, then we add a new column <code>ROW_NUMBER()</code> with partition by <code>user_id</code> and <code>product_id</code>. This is similar to <code>.groupby(['user_id','product_id'])</code> in <code>pandas</code>. Then the ordering is by <code>order_time</code> ascendingly, meaning the earliest order will be numbered as 1.</p><p>Due to the <code>ROW_NUMBER()</code> cannot in <code>WHERE</code> clause, we need to embed the query to select the rows we need. For dropping duplicates, <code>WHERE t.rn = 1</code> will do the trick. We can also keep the earliest 5 orders for all users:</p><pre><code class="language-SQL">SELECT	user_id
        ,product_id
        ,order_time
FROM (
        SELECT	user_id
                ,product_id
                ,order_time
                ,ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY order_time ASC) AS rn
        FROM    orders
) t
WHERE t.rn &lt;= 5
</code></pre><p>here only partition by user_id, and rn &lt;= 5</p><h2>Fill string with certain characters to a fixed length</h2><p><code>LPAD( string str, int len, string pad)</code> and <code>RPAD( string str, int len, string pad)</code></p><p>For example, <code>lpad('9:00:00',8,'0')</code> can be used to add a "0" in front of "9:00:00" so it becomes "09:00:00", but it won't add 0 to "13:00:00" since "13:00:00" has 8 characters.</p><h2>Get Object from JSON Embedded Rows</h2><pre><code class="language-SQL">SPLIT_PART(get_json_object(sentence,'$.redirect_url'),'-',2,2)
</code></pre><h2>Concat Distinct Values by Columns</h2><pre><code class="language-SQL">SELECT  user_id
        ,CONCAT_WS(',',COLLECT_SET(type)) AS types
        ,CONCAT_WS(',',COLLECT_SET(product_name)) AS product_names
FROM    user_purchase 
WHERE   ds = '${bizdate}'
GROUP BY user_id
</code></pre><h2>Get Percentile</h2><pre><code class="language-SQL">WITH score AS (
        SELECT  month
                ,user_id
                ,score
        FROM    user_score
)
SELECT  month
        ,percentile_approx(score,0)     AS score_0    -- min
        ,percentile_approx(score,0.05)  AS score_5    -- 5%
        ,percentile_approx(score,0.25)  AS score_25   -- 1st quarter
        ,percentile_approx(score,0.5)   AS score_50   -- median
        ,percentile_approx(score,0.75)  AS score_75   -- 3rd quarter
        ,percentile_approx(score,0.95)  AS score_95   -- 95%
        ,percentile_approx(score,1)     AS score_100  -- max
FROM    score
WHERE   month &gt;= '2020-09' 
GROUP BY month
ORDER BY month DESC
;
</code></pre><h2>Alter Table: add columns</h2><pre><code class="language-SQL"> ALTER TABLE `user_info` ADD COLUMNS (
     `user_age`         BIGINT COMMENT 'User Age'
    ,`user_location`    STRING COMMENT 'User Location'
);
</code></pre><h2>Calculate between Rows</h2><pre><code class="language-SQL"># get the previous row's create_time
LAG(create_time,1) OVER (PARTITION BY user_id ORDER BY create_time)

# calculate the time difference between current row's create_time and previous
# one, group by user_id
DATEDIFF(create_time,LAG(create_time,1) OVER (PARTITION BY user_id ORDER BY create_time),'SS' ) AS time_span
</code></pre><p>id<br>DATEDIFF(create_time,LAG(create_time,1) OVER (PARTITION BY user_id ORDER BY create_time),'SS' ) AS time_span</p><pre><code>Similarly, `LEAD()` is doing the opposite of `LAG()`, it will get the value of next n row(s).</code></pre></div><div class="authors"><div class="columns is-multiline"><div class="column"><div class="card" style="border-radius:6px;overflow:hidden;"><div class="card-content about-author has-text-centered"><a href="/example-node-eleventy/author/huangyuzhang/" class="has-text-grey-darker"><figure class="image is-96x96 is-margin-auto"><img class="image-squared box author-avatar lazyload" src="/example-node-eleventy/static/img/simon.jpeg" alt="Yuzhang Huang" title="Yuzhang Huang" data-src="/example-node-eleventy/static/img/simon.jpeg"></figure><div class="name is-main-font">Yuzhang Huang</div></a><ul class="meta-info is-size-6 has-text-grey-light" style="min-height:1rem;"><li><a href="https://yuzhang.me" target="_blank" class="has-text-grey"><i class="iconfont icon-home"></i></a></li><li><a href="https://github.com/huangyuzhang/" target="_blank" class="has-text-grey"><i class="iconfont icon-github"></i></a></li><li><span class="has-text-grey"><i class="iconfont icon-location"></i> Hangzhou, China</span></li></ul><div class="bio is-vcentered limit-text-line-3" style="min-height:1rem;" title="Keep it simple" alt="Keep it simple">Keep it simple</div></div><footer class="card-footer"><a href="/example-node-eleventy/author/huangyuzhang/" class="card-footer-item has-background-white-bis has-text-grey-darker">See all posts by Yuzhang Huang</a></footer></div></div></div></div></section></div></article></div><div class="column is-hidden-touch"><div id="toc"></div></div></div></section><section class="section is-mobile-paddingless"><div class="columns is-mobile" id="comments"><div class="column is-hidden-touch is-1-desktop is-1-widescreen is-2-fullhd"></div><div class="column is-12-tablet is-10-desktop is-10-widescreen is-8-fullhd"><script src="https://giscus.app/client.js" data-theme="light" crossorigin="anonymous" async=""></script></div><div class="column is-hidden-touch"></div></div></section><footer class="footer is-centered" style="padding-bottom:3rem;"><div class="content has-text-centered"><p class="copyright">© 2024 <a href="/example-node-eleventy/"><strong class="has-text-grey-darker">Fizzy</strong></a></p><p class="declare has-text-grey">The voyage begins in London.</p><p class="declare has-text-grey">Опубликованно с помощью <a href="https://www.11ty.dev/" target="_blank" rel="noopener noreferrer"><strong>Eleventy</strong> v2.0.1</a></p></div></footer><script src="/example-node-eleventy/static/js/footer.js"></script><script src="/example-node-eleventy/static/js/toc.js"></script><script>const toc = new fizzyToc({
          contentEl: 'content',
          tocEl: 'toc',
          linkClass: 'toc-item',
          linkActiveClass: 'current',
          selector: ['h2', 'h3'],
          supplyTop: 104,
          comments: true,
          commentsText: "Comments",
          active: function (el) {
          }
        });</script><script src="/example-node-eleventy/static/js/prism-line-numbers.min.js"></script><script defer="defer" src="/example-node-eleventy/static/js/prism.js"></script><script>document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body,{delimiters: [
              {left: "$$", right: "$$", display: true},
              {left: "$", right: "$", display: false},
              {left: "\\(", right: "\\)", display: false},
              {left: "\\[", right: "\\]", display: true}
          ]});
        });</script><script src="//instant.page/5.1.0" type="module" integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script><script>
            (function (selector, src, preferNativeLazyLoad) {
  var images = document.querySelectorAll(selector);
  var numImages = images.length;

  if (numImages > 0) {
    if (preferNativeLazyLoad && 'loading' in HTMLImageElement.prototype) {
      for (var i = 0; i < numImages; i++) {
        var keys = ['src', 'srcset'];

        for (var j = 0; j < keys.length; j++) {
          if (images[i].hasAttribute('data-' + keys[j])) {
            var value = images[i].getAttribute('data-' + keys[j]);
            images[i].setAttribute(keys[j], value);
          }
        }
      }

      return;
    }

    var script = document.createElement('script');
    script.async = true;
    script.src = src;
    document.body.appendChild(script);
  }
})(
              '.single-article img',
              'https://cdn.jsdelivr.net/npm/lazysizes@5/lazysizes.min.js',
              false
            );
          </script></body></html>